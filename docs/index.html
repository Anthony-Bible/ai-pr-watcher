<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PR Analytics: Volume vs Success Rate</title>
    <link rel="stylesheet" href="styles.css">
    <meta http-equiv="refresh" content="3600"> <!-- Auto-refresh every hour -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>PR Analytics: Volume vs Success Rate</h1>
            <p class="subtitle">Tracking Copilot vs Codex vs Cursor vs Devin PR performance</p>
        </header>

        <section class="data-sources">
            <h2>Data sources</h2>
            <p>Explore the GitHub search queries used:</p>
            <ul>
                <li><strong>All Copilot PRs</strong>: <a href="https://github.com/search?q=is:pr+head:copilot/&type=pullrequests">is:pr head:copilot/</a></li>
                <li><strong>Merged Copilot PRs</strong>: <a href="https://github.com/search?q=is:pr+head:copilot/+is:merged&type=pullrequests">is:pr head:copilot/ is:merged</a></li>
                <li><strong>All Codex PRs</strong>: <a href="https://github.com/search?q=is:pr+head:codex/&type=pullrequests">is:pr head:codex/</a></li>
                <li><strong>Merged Codex PRs</strong>: <a href="https://github.com/search?q=is:pr+head:codex/+is:merged&type=pullrequests">is:pr head:codex/ is:merged</a></li>
                <li><strong>All Cursor PRs</strong>: <a href="https://github.com/search?q=is:pr+head:cursor/&type=pullrequests">is:pr head:cursor/</a></li>
                <li><strong>Merged Cursor PRs</strong>: <a href="https://github.com/search?q=is:pr+head:cursor/+is:merged&type=pullrequests">is:pr head:cursor/ is:merged</a></li>
                <li><strong>All Devin PRs</strong>: <a href="https://github.com/search?q=author:devin-ai-integration[bot]&type=pullrequests">author:devin-ai-integration[bot]</a></li>
                <li><strong>Merged Devin PRs</strong>: <a href="https://github.com/search?q=author:devin-ai-integration[bot]+is:merged&type=pullrequests">author:devin-ai-integration[bot] is:merged</a></li>
            </ul>
        </section>

        <section class="chart">
            <h2>PR Analytics Chart</h2>
            <div class="chart-controls">
                <div class="control-group">
                    <label>Toggle Data Series:</label>
                    <div class="toggle-buttons">
                        <button id="toggleCopilot" class="toggle-btn active" data-agent="copilot">Copilot</button>
                        <button id="toggleCodex" class="toggle-btn active" data-agent="codex">Codex</button>
                        <button id="toggleCursor" class="toggle-btn active" data-agent="cursor">Cursor</button>
                        <button id="toggleDevin" class="toggle-btn active" data-agent="devin">Devin</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>Chart View:</label>
                    <div class="toggle-buttons">
                        <button id="viewAll" class="view-btn active" data-view="all">All Data</button>
                        <button id="viewBarsOnly" class="view-btn" data-view="bars">Volume Only</button>
                        <button id="viewLinesOnly" class="view-btn" data-view="lines">Success Rate Only</button>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="prChart" width="800" height="400"></canvas>
            </div>
            <div class="chart-fallback">
                <img src="chart.png" alt="PR Analytics Chart" class="chart-image">
                <p><em>Interactive chart failed to load. Showing static version.</em></p>
            </div>
        </section>

        <section class="statistics">
            <h2>Current Statistics</h2>
            <table>
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Total PRs</th>
                        <th>Merged PRs</th>
                        <th>Merge Rate</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Copilot</td>
                        <td>12,380</td>
                        <td>4,280</td>
                        <td>34.57%</td>
                    </tr>
                    <tr>
                        <td>Codex</td>
                        <td>113,011</td>
                        <td>92,601</td>
                        <td>81.94%</td>
                    </tr>
                    <tr>
                        <td>Cursor</td>
                        <td>245</td>
                        <td>175</td>
                        <td>71.43%</td>
                    </tr>
                    <tr>
                        <td>Devin</td>
                        <td>27,485</td>
                        <td>16,737</td>
                        <td>60.90%</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <footer>
            <p>Last updated: <span id="last-updated">June 04, 2025 20:37 UTC</span></p>
            <p><a href="https://github.com/aavetis/ai-pr-watcher">View on GitHub</a></p>
        </footer>
    </div>
    <script>
        // Load chart data and create interactive chart
        let chartInstance = null;
        let chartData = null;
        
        async function loadChartData() {
            try {
                const response = await fetch('chart-data.json');
                chartData = await response.json();
                initializeChart();
            } catch (error) {
                console.error('Failed to load chart data:', error);
                showFallback();
            }
        }
        
        function showFallback() {
            document.querySelector('.chart-container').style.display = 'none';
            document.querySelector('.chart-controls').style.display = 'none';
            document.querySelector('.chart-fallback').style.display = 'block';
        }
        
        function initializeChart() {
            const ctx = document.getElementById('prChart').getContext('2d');
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'PR Volume vs Success Rate',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'rect',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return 'Time: ' + context[0].label;
                                },
                                label: function(context) {
                                    const datasetLabel = context.dataset.label;
                                    const value = context.parsed.y;
                                    
                                    if (datasetLabel.includes('Success %')) {
                                        return datasetLabel + ': ' + value.toFixed(1) + '%';
                                    } else {
                                        return datasetLabel + ': ' + value.toLocaleString() + ' PRs';
                                    }
                                },
                                afterBody: function(context) {
                                    // Add summary information for the timestamp
                                    const index = context[0].dataIndex;
                                    const agents = ['copilot', 'codex', 'cursor', 'devin'];
                                    let summary = [];
                                    
                                    agents.forEach(agent => {
                                        const totalDataset = chartData.datasets.find(d => d.label === `${agent.charAt(0).toUpperCase() + agent.slice(1)} Total`);
                                        const mergedDataset = chartData.datasets.find(d => d.label === `${agent.charAt(0).toUpperCase() + agent.slice(1)} Merged`);
                                        const successDataset = chartData.datasets.find(d => d.label === `${agent.charAt(0).toUpperCase() + agent.slice(1)} Success %`);
                                        
                                        if (totalDataset && totalDataset.data[index] > 0) {
                                            const total = totalDataset.data[index];
                                            const merged = mergedDataset ? mergedDataset.data[index] : 0;
                                            const rate = successDataset ? successDataset.data[index] : 0;
                                            summary.push(`${agent.charAt(0).toUpperCase() + agent.slice(1)}: ${merged.toLocaleString()}/${total.toLocaleString()} (${rate.toFixed(1)}%)`);
                                        }
                                    });
                                    
                                    return summary.length > 0 ? [' ', 'Summary:', ...summary] : [];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Number of PRs'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Success Rate (%)'
                            },
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
            
            // Hide fallback and show interactive chart
            document.querySelector('.chart-fallback').style.display = 'none';
            document.querySelector('.chart-container').style.display = 'block';
            document.querySelector('.chart-controls').style.display = 'block';
            
            // Set up toggle functionality
            setupToggleButtons();
        }
        
        function setupToggleButtons() {
            const toggleButtons = document.querySelectorAll('.toggle-btn');
            const viewButtons = document.querySelectorAll('.view-btn');
            
            // Agent toggle functionality
            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const agent = this.dataset.agent;
                    const isActive = this.classList.contains('active');
                    
                    // Toggle button state
                    this.classList.toggle('active');
                    
                    // Get current view mode
                    const activeViewBtn = document.querySelector('.view-btn.active');
                    const currentView = activeViewBtn ? activeViewBtn.dataset.view : 'all';
                    
                    // Find and toggle datasets for this agent
                    chartInstance.data.datasets.forEach((dataset, index) => {
                        const labelLower = dataset.label.toLowerCase();
                        if (labelLower.includes(agent)) {
                            const isLine = dataset.type === 'line';
                            const isBar = dataset.type === 'bar';
                            
                            if (isActive) { // Was active, now hiding
                                dataset.hidden = true;
                            } else { // Was hidden, now showing (but respect view mode)
                                switch(currentView) {
                                    case 'all':
                                        dataset.hidden = false;
                                        break;
                                    case 'bars':
                                        dataset.hidden = isLine;
                                        break;
                                    case 'lines':
                                        dataset.hidden = isBar;
                                        break;
                                }
                            }
                        }
                    });
                    
                    chartInstance.update();
                });
            });
            
            // View mode functionality
            viewButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const view = this.dataset.view;
                    
                    // Update button states
                    viewButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show/hide datasets based on view mode and agent toggles
                    chartInstance.data.datasets.forEach(dataset => {
                        const isLine = dataset.type === 'line';
                        const isBar = dataset.type === 'bar';
                        
                        // Get the agent name from the dataset label
                        const agentMatch = dataset.label.toLowerCase().match(/(copilot|codex|cursor|devin)/);
                        const agent = agentMatch ? agentMatch[1] : null;
                        
                        // Check if agent is currently enabled
                        const agentButton = document.querySelector(`[data-agent="${agent}"]`);
                        const agentEnabled = agentButton && agentButton.classList.contains('active');
                        
                        switch(view) {
                            case 'all':
                                dataset.hidden = !agentEnabled;
                                break;
                            case 'bars':
                                dataset.hidden = !agentEnabled || isLine;
                                break;
                            case 'lines':
                                dataset.hidden = !agentEnabled || isBar;
                                break;
                        }
                    });
                    
                    chartInstance.update();
                });
            });
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadChartData();
        });
    </script>
</body>
</html>
